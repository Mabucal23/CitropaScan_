<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitroPaScan - Disease Detection Report</title> 
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
</head>
<body>
    <nav>
        <a href="{{ url_for('landing') }}" class="nav-logo">
            <span class="citro">Citro</span><span class="pa">Pa</span><span class="scan">Scan</span>
        </a>
        <div class="nav-links">
            <button id="downloadBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="fas fa-download me-2"></i>
                <span class="btn-text">Download Report</span>
                <div class="loading-spinner spinner-border spinner-border-sm ms-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </button>
            <a href="{{ url_for('profile') }}" class="profile-avatar">
                <img src="{{ url_for('static', filename=session.user.profile_pic if session.user.profile_pic else 'images/abstract-profile.png') }}" alt="Profile"/>
            </a>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="mb-3">
            <a href="{{ url_for('index') }}" class="btn btn-outline">
                &larr; Back to Dashboard
            </a>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 fw-bold mb-2">Disease Detection Report</h1>
                <p class="text-muted">Comprehensive analysis of calamansi health predictions</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="glass-card summary-card">
                    <div class="summary-number">{{ total_scans }}</div>
                    <div class="summary-label">Total Scans</div>
                    <small class="text-muted">Calamansi analyzed</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="glass-card summary-card">
                    <div class="summary-number healthy">{{ healthy_count }}</div>
                    <div class="summary-label">Healthy Calamansi</div>
                    <small class="text-muted">{{ (healthy_count/total_scans*100)|round(1) if total_scans > 0 else 0 }}% of total scans</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="glass-card summary-card">
                    <div class="summary-number disease">{{ disease_count }}</div>
                    <div class="summary-label">Disease Detected</div>
                    <small class="text-muted">{{ (disease_count/total_scans*100)|round(1) if total_scans > 0 else 0 }}% of total scans</small>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="glass-card summary-card">
                    <div class="summary-number warning">{{ avg_confidence }}%</div>
                    <div class="summary-label">Avg Confidence</div>
                    <small class="text-muted">Model accuracy</small>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="glass-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Disease Distribution</h5>
                        <small class="text-muted">Percentage breakdown of detected conditions</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="diseaseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="glass-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Monthly Scan Activity</h5>
                        <small class="text-muted">Number of scans performed each month</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="glass-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Recent Predictions</h5>
                        <small class="text-muted">Latest disease detection results with confidence scores</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Disease/Condition</th>
                                        <th>Status</th>
                                        <th>Confidence</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="predictionsTable">
                                    {% for pred in predictions %}
                                    <tr>
                                        <td>#{{ pred.id }}</td>
                                        <td>{{ pred.disease }}</td>
                                        <td>
                                            {% if pred.status == 'fresh' %}
                                                <span class="badge badge-healthy">Healthy</span>
                                            {% else %}
                                                <span class="badge badge-disease">Disease Detected</span>
                                            {% endif %}
                                        </td>
                                        <td class="{% if pred.confidence >= 90 %}confidence-high{% elif pred.confidence >= 80 %}confidence-medium{% else %}confidence-low{% endif %} fw-bold">
                                            {{ pred.confidence|round(2) }}%
                                        </td>
                                        <td class="text-muted">{{ pred.timestamp }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exportModalLabel">Export / Print Report</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p>Select an option to export or print the report:</p>
            <div class="d-grid gap-2">
              <button class="btn btn-secondary" id="exportCsvBtn"><i class="fas fa-file-csv me-2"></i>Export as CSV</button>
              <button class="btn btn-primary" id="exportPdfBtn"><i class="fas fa-file-pdf me-2"></i>Export as PDF</button>
              <button class="btn btn-outline" id="printBtn"><i class="fas fa-print me-2"></i>Print</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Get theme colors from CSS variables
        const themeColors = getComputedStyle(document.documentElement);
        const colorPrimary = themeColors.getPropertyValue('--color-primary').trim();
        const colorSecondary = themeColors.getPropertyValue('--color-secondary').trim();
        const colorDanger = themeColors.getPropertyValue('--color-danger').trim();
        const colorText = themeColors.getPropertyValue('--color-text').trim();
        const colorTextMuted = themeColors.getPropertyValue('--color-text-muted').trim();
        const colorGrid = 'rgba(255, 255, 255, 0.2)';
        const colorBorder = 'rgba(0, 0, 0, 0.2)';

        // Get data from Jinja
        const diseaseCounts = {{ disease_counts|tojson }};
        const monthlyCounts = {{ monthly_counts|tojson }};

        // --- Pie Chart ---
        const pieCtx = document.getElementById('diseaseChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(diseaseCounts),
                datasets: [{
                    data: Object.values(diseaseCounts),
                    backgroundColor: [
                        colorSecondary, // Healthy
                        colorDanger,    // Canker
                        colorPrimary,   // Black Spot
                        '#8b5cf6'       // Greening
                    ],
                    borderColor: colorBorder,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: colorText }
                    }
                }
            }
        });

        // --- Bar Chart ---
        const barCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(monthlyCounts),
                datasets: [{
                    label: 'Scans',
                    data: Object.values(monthlyCounts),
                    backgroundColor: colorSecondary,
                    borderColor: colorSecondary,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        ticks: { color: colorTextMuted }, 
                        grid: { color: 'transparent' } 
                    },
                    y: { 
                        ticks: { color: colorTextMuted }, 
                        grid: { color: colorGrid } 
                    }
                }
            }
        });

        // --- Print Functionality ---
        document.getElementById('printBtn').addEventListener('click', () => {
            const table = document.getElementById('predictionsTable').closest('.table-responsive');
            const newWin = window.open('', '', 'width=900,height=700');
            
            // ** UPDATED PRINT STYLES TO MATCH OUR THEME **
            newWin.document.write(`
                <html>
                <head>
                    <title>Print Report</title>
                    <style>
                        body { 
                            font-family: 'Poppins', sans-serif;
                            background-color: #222; 
                            color: #f4f4f4; 
                            padding: 20px;
                        }
                        h2 {
                            color: ${colorPrimary};
                            border-bottom: 2px solid ${colorPrimary};
                            padding-bottom: 10px;
                        }
                        .table { 
                            width: 100%;
                            border-collapse: collapse;
                            color: #ddd; 
                        }
                        .table th, .table td { 
                            border: 1px solid #555; 
                            padding: 8px;
                            text-align: left;
                        }
                        .table th {
                            background-color: #333;
                            color: #f4f4f4;
                        }
                        .badge {
                            padding: 3px 8px;
                            border-radius: 12px;
                            font-size: 0.8rem;
                            font-weight: 600;
                            border: 1px solid transparent;
                        }
                        .badge-healthy {
                            background-color: rgba(40, 167, 69, 0.15);
                            color: #28a745;
                            border-color: rgba(40, 167, 69, 0.3);
                        }
                        .badge-disease {
                            background-color: rgba(239, 68, 68, 0.15);
                            color: #ef4444;
                            border-color: rgba(239, 68, 68, 0.3);
                        }
                    </style>
                </head>
                <body>
                    <h2>CitroPaScan Report - Scan History</h2>
                    ${table.outerHTML}
                </body>
                </html>
            `);
            newWin.document.close();
            newWin.focus();
            newWin.print();
        });
        
        // --- PDF Export Functionality ---
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("CitroPaScan - Scan History Report", 14, 16);
            
            doc.autoTable({
                html: '#predictionsTable',
                startY: 22,
                theme: 'striped', // 'striped', 'grid', 'plain'
                headStyles: { fillColor: [255, 140, 66] }, // Our --color-primary
                styles: {
                    cellPadding: 2,
                    fontSize: 8,
                },
            });

            doc.save('citropascan_report.pdf');
        });

        // --- CSV Export Functionality ---
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Disease/Condition,Status,Confidence,Timestamp\n"; // Header row

            const rows = document.querySelectorAll("#predictionsTable tr");
            
            rows.forEach(row => {
                let rowContent = [];
                row.querySelectorAll("td").forEach(cell => {
                    rowContent.push(`"${cell.innerText.trim()}"`);
                });
                csvContent += rowContent.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "citropascan_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>